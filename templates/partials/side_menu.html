<style>
  .tm-section-title {
    margin: 8px 0 6px;
    font-size: 13px;
    font-weight: 700;
    color: #555;
    letter-spacing: .2px;
  }
  /* Visual nesting for playlists tree */
  #tm-playlists > li > ul.tm-list {
    margin-left: 12px;
    padding-left: 12px;
    border-left: 1px solid #eee;
  }
</style>
<div class="tm-inner">
  <nav class="tm-nav" aria-label="Primary">
    <ul class="tm-list">
      <li><a class="tm-link" href="/">Home</a></li>
      <li><a class="tm-link" href="/trending">Trending</a></li>
      <li><a class="tm-link" href="/subscriptions">Subscriptions</a></li>
      <li><a class="tm-link" href="/history">History</a></li>
    </ul>
  </nav>

  <div class="tm-sep"><hr></div>
  <h4 class="tm-section-title">My playlists</h4>
  <nav class="tm-nav" aria-label="Playlists">
    <ul class="tm-list" id="tm-playlists"></ul>
  </nav>
</div>

<script>
(function(){
  // Render playlists tree for auth users
  var hasUser = {{ 'true' if current_user else 'false' }};
  if (!hasUser) return;

  function el(tag, cls){ var x = document.createElement(tag); if (cls) x.className = cls; return x; }

  function renderTree(container, nodes){
    if (!nodes || !nodes.length) return;
    nodes.forEach(function(n){
      var li = el('li');
      var linkHref = null;
      if (n.first_video_id) {
        linkHref = '/watch?v=' + encodeURIComponent(n.first_video_id) + '&p=' + encodeURIComponent(n.playlist_id);
      }
      var a = el('a', 'tm-link');
      a.textContent = n.name || '(untitled)';
      a.href = linkHref || '/playlists';
      li.appendChild(a);

      if (Array.isArray(n.children) && n.children.length > 0) {
        var ul = el('ul', 'tm-list');
        renderTree(ul, n.children);
        li.appendChild(ul);
      }
      container.appendChild(li);
    });
  }

  async function loadPlaylists(){
    try {
      var res = await fetch('/playlists/api/my-tree', { credentials: 'same-origin' });
      if (!res.ok) return;
      var js = await res.json();
      var root = document.getElementById('tm-playlists');
      if (!root) return;
      root.innerHTML = '';
      renderTree(root, js && js.items || []);
    } catch(e) {}
  }

  loadPlaylists();
})();
</script>