<div class="addto-inline" id="addto-inline" style="display:inline-block; position:relative; margin-left:8px;">
  <button type="button"
          class="addto-trigger"
          aria-haspopup="menu"
          aria-expanded="false"
          aria-controls="addto-flyout"
          style="padding:6px 10px; border:1px solid #ccc; border-radius:6px; background:#fff; color:#111; cursor:pointer;">
    Add to…
  </button>

  <div class="addto-flyout"
       id="addto-flyout"
       role="menu"
       aria-label="Add to playlist"
       hidden
       style="position:absolute; top:calc(100% + 6px); right:0; z-index:1500; min-width:220px; max-width:280px; background:#fff; border:1px solid #ddd; border-radius:8px; box-shadow:0 8px 20px rgba(0,0,0,0.12); padding:6px;">
    {% set _show_watch_later = show_watch_later|default(true) %}
    {% set _show_favorites   = show_favorites|default(true) %}
    <ul class="addto-list" role="none" style="list-style:none; margin:0; padding:0;">
      {% if _show_watch_later %}
        <li role="none"><button type="button" role="menuitem" class="addto-item" data-action="watch_later" style="width:100%; text-align:left; padding:8px 10px; border:none; background:transparent; cursor:pointer; border-radius:6px;">Watch later</button></li>
      {% endif %}
      {% if _show_favorites %}
        <li role="none"><button type="button" role="menuitem" class="addto-item" data-action="favorites" style="width:100%; text-align:left; padding:8px 10px; border:none; background:transparent; cursor:pointer; border-radius:6px;">Favorites</button></li>
      {% endif %}

      {% if playlists and playlists|length > 0 %}
        {% for p in playlists %}
          <li role="none">
            <button type="button"
                    role="menuitem"
                    class="addto-item"
                    data-action="playlist"
                    data-playlist-id="{{ p['playlist_id'] }}"
                    style="width:100%; text-align:left; padding:8px 10px; border:none; background:transparent; cursor:pointer; border-radius:6px;">
              {{ p['name'] }}
            </button>
          </li>
        {% endfor %}
      {% else %}
        <li role="none" class="addto-empty" style="opacity:0.7; padding:8px 10px;">No playlists yet</li>
      {% endif %}

      <li role="none" class="addto-sep" style="border-top:1px solid #eee; margin:6px 0;"></li>
      <li role="none"><button type="button" role="menuitem" class="addto-new" data-action="new" style="width:100%; text-align:left; padding:8px 10px; border:none; background:transparent; cursor:pointer; border-radius:6px;">New Playlist…</button></li>

      <li role="none" class="addto-create-form" id="addto-create-form" hidden style="padding:8px 10px;">
        <div style="display:flex; flex-direction:column; gap:8px;">
          <input type="text" class="addto-new-name" placeholder="Playlist name" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;">
          <select class="addto-new-vis" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;">
            <option value="private">Private</option>
            <option value="unlisted">Unlisted</option>
            <option value="public">Public</option>
          </select>
          <div style="display:flex; gap:8px; justify-content:flex-end;">
            <button type="button" class="addto-create-do" style="padding:6px 10px; border:1px solid #ccc; border-radius:6px; background:#fff; cursor:pointer;">Create</button>
            <button type="button" class="addto-create-cancel" style="padding:6px 10px; border:1px solid #eee; border-radius:6px; background:#f5f5f5; cursor:pointer;">Cancel</button>
          </div>
        </div>
      </li>
    </ul>
  </div>
</div>

<style>
  .addto-flyout .addto-item { transition: background-color .12s ease; }
  .addto-flyout .addto-item:hover { background: #f3f7ff !important; }
  .addto-flyout .addto-item:focus-visible { outline: 2px solid #aac4ff; outline-offset: 2px; }
</style>

<div id="addto-backdrop" hidden
     style="position:fixed; inset:0; background:rgba(0,0,0,0.25); z-index:900;"></div>

<script>
(function(){
  var root = document.getElementById('addto-inline');
  if (!root) return;
  var trigger = root.querySelector('.addto-trigger');
  var flyout = root.querySelector('#addto-flyout');
  var backdrop = document.getElementById('addto-backdrop');

  function openFlyout() {
    flyout.hidden = false;
    trigger.setAttribute('aria-expanded', 'true');
    if (backdrop) backdrop.hidden = false;
    // Close when clicking outside
    setTimeout(function(){
      document.addEventListener('click', onDocClick, { capture: true, once: true });
    }, 0);
    refreshPlaylists();
  }
  function closeFlyout() {
    flyout.hidden = true;
    trigger.setAttribute('aria-expanded', 'false');
    if (backdrop) backdrop.hidden = true;
    hideCreateForm();
  }
  function onDocClick(ev) {
    if (!root.contains(ev.target)) closeFlyout();
  }

  // Prevent global handlers from immediately closing the menu
  trigger.addEventListener('click', function(e){
    e.preventDefault();
    e.stopPropagation();
    if (flyout.hidden) openFlyout(); else closeFlyout();
  });
  // Prevent bubbling clicks inside the flyout from being treated as "outside"
  flyout.addEventListener('click', function(e){ e.stopPropagation(); });

  if (backdrop) backdrop.addEventListener('click', closeFlyout);
  document.addEventListener('keydown', function(ev){
    if (ev.key === 'Escape') closeFlyout();
  });

  function getCSRF() {
    var m = document.cookie.match(/(?:^|; )yt_csrf=([^;]*)/);
    return m ? decodeURIComponent(m[1]) : '';
  }

  function bindPlaylistButton(btn){
    if (!btn) return;
    btn.addEventListener('click', async function(e){
      e.preventDefault();
      e.stopPropagation();
      var plid = btn.getAttribute('data-playlist-id') || '';
      var vr = document.getElementById('video-reactions');
      var vid = vr ? vr.getAttribute('data-video-id') : '';
      try {
        await fetch('/playlists/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': getCSRF() },
          body: JSON.stringify({ playlist_id: plid, video_id: vid })
        });
      } catch(e) { /* ignore */ }
      closeFlyout();
    });
  }

  function renderPlaylists(items){
    var ul = flyout.querySelector('.addto-list');
    if (!ul) return;

    ul.querySelectorAll('li > button.addto-item[data-action="playlist"]').forEach(function(btn){
      var li = btn.closest('li');
      if (li) li.remove();
    });
    var empty = ul.querySelector('.addto-empty');
    if (empty) empty.remove();

    var filtered = Array.isArray(items) ? items.filter(function(p){
      var t = (p.type || '').toString();
      return !(t === 'system_watch_later' || t === 'system_favorites' || t.indexOf('system_') === 0);
    }) : [];

    var sep = ul.querySelector('.addto-sep');
    var insertBeforeNode = sep || ul.lastElementChild;

    if (!filtered || filtered.length === 0) {
      var liEmpty = document.createElement('li');
      liEmpty.setAttribute('role','none');
      liEmpty.className = 'addto-empty';
      liEmpty.style.opacity = '0.7';
      liEmpty.style.padding = '8px 10px';
      liEmpty.textContent = 'No playlists yet';
      ul.insertBefore(liEmpty, insertBeforeNode);
      return;
    }

    filtered.forEach(function(p){
      var li = document.createElement('li');
      li.setAttribute('role','none');

      var btn = document.createElement('button');
      btn.type = 'button';
      btn.setAttribute('role','menuitem');
      btn.className = 'addto-item';
      btn.setAttribute('data-action', 'playlist');
      btn.setAttribute('data-playlist-id', p.playlist_id || '');
      btn.style.width = '100%';
      btn.style.textAlign = 'left';
      btn.style.padding = '8px 10px';
      btn.style.border = 'none';
      btn.style.background = 'transparent';
      btn.style.cursor = 'pointer';
      btn.style.borderRadius = '6px';
      btn.textContent = p.name || 'Playlist';

      li.appendChild(btn);
      ul.insertBefore(li, insertBeforeNode);
      bindPlaylistButton(btn);
    });
  }

  async function refreshPlaylists(){
    try {
      var res = await fetch('/playlists/my', { method: 'GET', headers: { 'Accept': 'application/json' } });
      if (!res.ok) return;
      var js = await res.json();
      var items = (js && js.items) ? js.items : [];
      renderPlaylists(items);
    } catch(e) { /* ignore */ }
  }

  // Watch later
  var watchLaterBtn = flyout.querySelector('button.addto-item[data-action="watch_later"]');
  if (watchLaterBtn) {
    watchLaterBtn.addEventListener('click', async function(e){
      e.preventDefault();
      e.stopPropagation();

      var vr = document.getElementById('video-reactions');
      var vid = vr ? vr.getAttribute('data-video-id') : '';

      try {
        await fetch('/playlists/watch_later', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': getCSRF() },
          body: JSON.stringify({ video_id: vid })
        });
      } catch(e) { /* ignore */ }

      closeFlyout();
    });
  }

  // Favorites
  var favoritesBtn = flyout.querySelector('button.addto-item[data-action="favorites"]');
  if (favoritesBtn) {
    favoritesBtn.addEventListener('click', async function(e){
      e.preventDefault();
      e.stopPropagation();

      var vr = document.getElementById('video-reactions');
      var vid = vr ? vr.getAttribute('data-video-id') : '';

      try {
        await fetch('/playlists/favorites', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': getCSRF() },
          body: JSON.stringify({ video_id: vid })
        });
      } catch(e) { /* ignore */ }

      closeFlyout();
    });
  }

  flyout.querySelectorAll('button.addto-item[data-action="playlist"]').forEach(bindPlaylistButton);

  var newBtn = flyout.querySelector('button.addto-new[data-action="new"]');
  var newBtnLi = newBtn ? newBtn.closest('li') : null;
  var formLi = flyout.querySelector('#addto-create-form');
  var nameInput = formLi ? formLi.querySelector('.addto-new-name') : null;
  var visSelect = formLi ? formLi.querySelector('.addto-new-vis') : null;
  var createDo = formLi ? formLi.querySelector('.addto-create-do') : null;
  var createCancel = formLi ? formLi.querySelector('.addto-create-cancel') : null;

  function showCreateForm(){
    if (!formLi || !newBtnLi) return;
    newBtnLi.hidden = true;
    formLi.hidden = false;
    if (nameInput) { nameInput.value = ''; nameInput.focus(); }
    if (visSelect) { visSelect.value = 'private'; }
  }
  function hideCreateForm(){
    if (!formLi || !newBtnLi) return;
    formLi.hidden = true;
    newBtnLi.hidden = false;
    if (nameInput) nameInput.value = '';
  }

  if (newBtn) {
    newBtn.addEventListener('click', function(e){
      e.preventDefault();
      e.stopPropagation();
      showCreateForm();
    });
  }
  if (createCancel) {
    createCancel.addEventListener('click', function(e){
      e.preventDefault();
      e.stopPropagation();
      hideCreateForm();
    });
  }

  if (createDo) {
    createDo.addEventListener('click', async function(e){
      e.preventDefault();
      e.stopPropagation();

      var name = nameInput ? (nameInput.value || '').trim() : '';
      var vis  = visSelect ? (visSelect.value || 'private') : 'private';
      if (!name) {
        if (nameInput) nameInput.focus();
        return;
      }

      createDo.disabled = true;
      try {
        var res = await fetch('/playlists/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': getCSRF() },
          body: JSON.stringify({ name: name, visibility: vis })
        });
        var js = await res.json();
        var plid = js && js.playlist_id ? js.playlist_id : '';

        if (plid) {
          var vr = document.getElementById('video-reactions');
          var vid = vr ? vr.getAttribute('data-video-id') : '';
          await fetch('/playlists/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': getCSRF() },
            body: JSON.stringify({ playlist_id: plid, video_id: vid })
          });
          await refreshPlaylists();
          closeFlyout();
        }
      } catch(err) {
        // ignore
      } finally {
        createDo.disabled = false;
        hideCreateForm();
      }
    });
  }

  if (nameInput) {
    nameInput.addEventListener('keydown', function(ev){
      if (ev.key === 'Enter') {
        ev.preventDefault();
        if (createDo && !createDo.disabled) createDo.click();
      }
      if (ev.key === 'Escape') {
        ev.preventDefault();
        hideCreateForm();
      }
    });
  }

  // Item handlers (placeholder; integrate with routes later)
  root.addEventListener('click', async function(ev){
    var btn = ev.target.closest('.addto-item, .addto-new');
    if (!btn) return;
  });
})();
</script>