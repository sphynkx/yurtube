{% extends "base.html" %}
{% block content %}
<h1>Search</h1>

<form action="/search" method="get" style="margin-bottom:12px;">
  <input type="text" name="q" value="{{ query }}" placeholder="Search videos..." style="width:70%;">
  <button type="submit">Find</button>
  <span style="margin-left:8px; font-size:12px; color:#666;">engine: {{ engine }}</span>
</form>

{% if results and results|length > 0 %}
  <ul style="list-style:none; padding:0; margin:0;">
  {% for v in results %}
    <li style="display:flex; gap:12px; padding:10px 0; border-top:1px solid #eee; align-items:flex-start;">
      <div class="thumb-wrap" style="flex:0 0 220px; aspect-ratio:16/9; background:#000; overflow:hidden; border-radius:6px;">
        <a href="/watch?v={{ v['video_id'] }}" style="display:block; width:100%; height:100%;">
          <img
            class="result-thumb"
            src="{{ v.get('thumb_url') or '/static/img/thumb_default.svg' }}"
            {% if v.get('thumb_url_anim') %} data-anim="{{ v['thumb_url_anim'] }}" {% endif %}
            {% if v.get('thumb_url') %} data-static="{{ v['thumb_url'] }}" {% endif %}
            alt="thumb"
            style="width:100%; height:100%; object-fit:cover;"
            loading="lazy"
            onerror="this.onerror=null;this.src='/static/img/thumb_default.svg';"
          >
        </a>
      </div>
      <div style="flex:1 1 auto; min-width:0;">
        <div style="font-weight:bold; font-size:16px; line-height:1.3; margin-bottom:4px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
          <a href="/watch?v={{ v['video_id'] }}" style="color:#111; text-decoration:none;">
            {{ v['title'] }}
          </a>
        </div>
        <div style="display:flex; align-items:center; gap:8px; font-size:12px; color:#666; margin-bottom:6px;">
          <img
            src="{{ v.get('avatar_url') or '/static/img/avatar_default.svg' }}"
            alt="avatar"
            style="width:20px; height:20px; border-radius:50%; object-fit:cover;"
            loading="lazy"
            onerror="this.onerror=null;this.src='/static/img/avatar_default.svg';"
          >
          <span>{{ v.get('author','') }}</span>
          {% if v.get('category') %}
            <span>&middot; {{ v['category'] }}</span>
          {% endif %}
          {% if v.get('uploaded_at') %}
            <span>&middot; {{ v['uploaded_at'] }}</span>
          {% endif %}
          <span>&middot; {{ v.get('views_count',0) }} views</span>
        </div>
        <div style="font-size:13px; color:#333; max-height:3.2em; overflow:hidden;">
          {{ v.get('description','') }}
        </div>
      </div>
    </li>
  {% endfor %}
  </ul>

  <script>
  // Simple hover swap for animated thumbnails when available.
  // Only enable on devices that support hover to avoid churn on touch screens.
  (function() {
    var mql = window.matchMedia("(hover: hover)");
    if (!mql || !mql.matches) return;

    function onEnter(e) {
      var img = e.currentTarget;
      var anim = img.getAttribute("data-anim");
      if (!anim) return;
      // Prefetch once
      if (!img._animPrefetched) {
        var pre = new Image();
        pre.src = anim;
        img._animPrefetched = true;
      }
      img._staticSrc = img.getAttribute("data-static") || img.src;
      img.src = anim;
    }

    function onLeave(e) {
      var img = e.currentTarget;
      var st = img._staticSrc || img.getAttribute("data-static");
      if (st) img.src = st;
    }

    var imgs = document.querySelectorAll("img.result-thumb[data-anim]");
    imgs.forEach(function(img) {
      img.addEventListener("mouseenter", onEnter);
      img.addEventListener("mouseleave", onLeave);
    });
  })();
  </script>
{% else %}
  <p>No results.</p>
{% endif %}
{% endblock %}