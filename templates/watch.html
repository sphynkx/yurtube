{% extends "base.html" %}
{% import "players_macros.html" as pm %}

{% block content %}

{% set _not_found = not_found|default(false) %}
{% set _fallback_img = fallback_image_url|default("/static/img/fallback_video_notfound.gif") %}

{% set sidebar_list = [] %}
{% if recommended_videos is defined and recommended_videos %}
  {% set sidebar_list = recommended_videos %}
{% elif upnext is defined and upnext %}
  {% set sidebar_list = upnext %}
{% elif related_videos is defined and related_videos %}
  {% set sidebar_list = related_videos %}
{% elif related is defined and related %}
  {% set sidebar_list = related %}
{% elif recommendations is defined and recommendations %}
  {% set sidebar_list = recommendations %}
{% elif suggested_videos is defined and suggested_videos %}
  {% set sidebar_list = suggested_videos %}
{% elif next_videos is defined and next_videos %}
  {% set sidebar_list = next_videos %}
{% elif videos_right is defined and videos_right %}
  {% set sidebar_list = videos_right %}
{% endif %}

{% set comments_list = comments if comments is defined else [] %}
{% set _has_right = (sidebar_list|length > 0) and (not _not_found) %}

<style>
/*TODO: Move it to sep.file!! */
/* Base grid: left - content, right - "up next" */
.watch-layout {
  display:grid;
  gap:16px;
  align-items:start;
  grid-template-columns:{% if _has_right %} minmax(0,1fr) 360px {% else %} 1fr {% endif %};
}

/* Theater: single col */
.watch-layout.theater-mode {
  grid-template-columns: 1fr !important;
}

.watch-right {
  width:360px;
  justify-self:end;
  align-self:start;
}
.watch-layout.theater-mode .watch-right {
  /* for theater - hide aside, move it's content into under-right-slot */
  display:none !important;
}

/* Short width: 1 col, right col is hidden; tabs displayed; placeholder is hidden */
@media (max-width:1100px) {
  .watch-layout { grid-template-columns: 1fr !important; }
  .watch-right { display:none !important; }
  .watch-tabs { display:block !important; }
  .watch-layout.theater-mode .watch-tabs { display:block !important; }
  #comments-mount-wide .comments-placeholder { display: none; }
}

/* Mobile width for original rail */
@media (max-width:420px) {
  .watch-right { width:100%; justify-self:stretch; }
}

/* Row under player: for teater - 2 cols; else -just block */
.under-row { display:block; }
@media (min-width:1101px) {
  .watch-layout.theater-mode .under-row {
    display:grid;
    grid-template-columns: minmax(0,1fr) 360px;
    gap:16px;
    align-items:start;
  }
}
.under-left { min-width:0; }
.under-right-slot { width:360px; }

/* Hover thumbs */
.rb-item .rb-thumb { position:relative; width:160px; flex:0 0 160px; aspect-ratio:16/9; background:#000; overflow:hidden; }
.rb-item .rb-thumb img { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; transition:opacity .15s ease; }
.rb-item .rb-thumb .rb-thumb-static { opacity:1; }
.rb-item .rb-thumb .rb-thumb-anim { opacity:0; }
.rb-item:hover .rb-thumb .rb-thumb-static { opacity:0; }
.rb-item:hover .rb-thumb .rb-thumb-anim { opacity:1; }

/* Tabs */
.watch-tabs { display:none; }
.tabs-nav { display:flex; gap:6px; border-bottom:1px solid #ddd; margin-top:14px; }
.tabs-nav button {
  appearance:none; border:0; background:#f3f3f3; padding:8px 12px;
  cursor:pointer; font-weight:600; border-top-left-radius:6px; border-top-right-radius:6px;
}
.tabs-nav button[aria-selected="true"] { background:#e9e9e9; }
.tab-panels { border:1px solid #ddd; border-top:0; border-bottom-left-radius:6px; border-bottom-right-radius:6px; padding:10px; }
.tab-panel { display:none; }
.tab-panel.active { display:block; }

.comments-placeholder {
  margin-top:16px;
  border:1px dashed #c7d8e6;
  padding:14px 16px;
  border-radius:8px;
  background:#f7fbff;
  font-size:14px;
  color:#335;
}
.comments-placeholder-inner { font-style:italic; opacity:.9; }

/* Debug option: Enable borders: data-debug="1"
body[data-debug="1"] .watch-layout * { outline:1px dashed rgba(0, 100, 255, .15); }
*/

/* Compound title with Embed block to 1 line */
.title-row {
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:16px;
  flex-wrap:wrap;
  margin-top:12px;
}
.title-row .watch-title {
  margin:0;
  flex:1 1 auto;
  min-width:200px;
}
.embed-inline {
  display:flex;
  flex:0 0 auto;
  max-width:160px;      /* limit width (not work.. 2DEL) */
  justify-content:flex-end;
  align-self:flex-start;
}
.embed-inline details { width:100%; }
.embed-box summary {
  cursor:pointer;
  font-weight:600;
  padding:4px 8px;
  border-radius:6px;
  background:#f3f3f3;
  font-size:13px;
}
.embed-box summary:hover { background:#e9e9e9; }
.embed-body {
  margin-top:6px;
  display:flex;
  flex-direction:column;
  gap:6px;
}
.embed-code {
  width:100%;
  font-family:monospace;
  font-size:12px;
  padding:6px;
  border:1px solid #ccc;
  border-radius:6px;
  resize:vertical;
  background:#fff;
  box-sizing:border-box;
}
.btn-copy-embed {
  align-self:flex-end;
  padding:4px 10px;
  font-size:12px;
  border:1px solid #bbb;
  background:#fff;
  border-radius:6px;
  cursor:pointer;
}
.btn-copy-embed:hover { background:#f0f0f0; }

@media (max-width:700px){
  .title-row { flex-direction:column; align-items:stretch; }
  .embed-inline { justify-content:flex-start; max-width:100%; }
}

/* Limit width till player width */
.video-primary-block { max-width:650px; }
@media (max-width:600px){ .video-primary-block { max-width:100%; } }

/* Popover for Embed */
.embed-inline { position:relative; flex:0 0 auto; }
.embed-trigger {
  appearance:none; border:1px solid #bbb; background:#fff;
  padding:4px 10px; border-radius:6px; cursor:pointer; font-weight:600; font-size:13px;
}
.embed-trigger:hover { background:#f3f3f3; }

#embed-backdrop {
  position:fixed; inset:0; background:rgba(0,0,0,.15);
  z-index:3990; display:block;
}
#embed-backdrop[hidden] { display:none; }

.embed-flyout {
  position:absolute; right:0; top:calc(100% + 8px);
  width:480px; max-width:min(92vw, 560px);
  background:#fff; border:1px solid #ddd; border-radius:8px;
  box-shadow:0 10px 30px rgba(0,0,0,.15);
  z-index:4000; padding:10px;
}
.embed-flyout[hidden] { display:none; }

.embed-caret {
  position:absolute; right:18px; top:-8px; width:14px; height:14px;
  background:#fff; border-left:1px solid #ddd; border-top:1px solid #ddd;
  transform:rotate(45deg);
}

.embed-body { display:flex; flex-direction:column; gap:6px; }
.embed-label { font-size:12px; color:#333; }
.embed-code {
  width:100%; font-family:monospace; font-size:12px;
  padding:6px; border:1px solid #ccc; border-radius:6px; resize:vertical; background:#fff; box-sizing:border-box;
}
.embed-actions { display:flex; gap:8px; justify-content:flex-end; }
.btn-copy-embed, .btn-close-embed {
  padding:4px 10px; font-size:12px; border:1px solid #bbb; background:#fff; border-radius:6px; cursor:pointer;
}
.btn-copy-embed:hover, .btn-close-embed:hover { background:#f0f0f0; }

@media (max-width:700px){
  .embed-flyout {
    position:fixed; left:50%; transform:translateX(-50%);
    right:auto; top:10vh; width:min(92vw, 560px); max-width:92vw;
  }
  .embed-caret { display:none; }
}
</style>
<link href="/static/css/video_reactions.css" rel="stylesheet">

<div class="watch-layout">

  <div class="watch-main">
    <div class="player-wrapper">
      {% if _not_found %}
        <div class="player-fallback" style="width:min(95vw,560px);">
          <img src="{{ _fallback_img }}" alt="Video not found"
               style="display:block;width:100%;height:auto;background:#000;">
        </div>
      {% else %}
        {{ pm.render_player(
             player_name=player_name,
             video_src=video_src,
             poster_url=poster_url,
             video_id=video['video_id'] if video else None,
             subtitles=subtitles,
             options=player_options
           ) }}
      {% endif %}
    </div>

    <!-- (1) Row under player -->
    <div class="under-row" id="under-row">
{% include "partials/video_reactions.html" %}
      <!-- (1.1) Left block -->
      <div class="under-left" id="under-left">
        {% if video %}

<div class="video-primary-block">
  <div class="title-row">
    <h2 class="watch-title">{{ video['title'] }}</h2>
  </div>

  <div class="video-info">
    <div class="watch-meta" style="margin-top:12px; display:flex; flex-direction:column; gap:6px;">
      <div class="author-line" style="display:inline-flex;align-items:center;gap:8px;">
        {% if avatar_url %}<img class="mini-avatar" src="{{ avatar_url }}" alt="avatar">{% endif %}
        {% if video.channel_id %}
          <a class="author-name" href="/channel/{{ video.channel_id }}">{{ (video.username or video.channel_id) or "" }}</a>
        {% elif video.username %}
          <a class="author-name" href="/user/{{ video.username }}">{{ video.username }}</a>
        {% else %}
          <span class="author-name">{{ (video.username or video.channel_id) or "" }}</span>
        {% endif %}
      </div>
      <div class="watch-date">
        {% if video.created_at %}
          {% if video.created_at.__class__.__name__ == 'datetime' %}
            {{ video.created_at.strftime("%Y-%m-%d") }}
          {% else %}
            {{ video.created_at }}
          {% endif %}
        {% endif %}
      </div>
      <div class="watch-stats" style="display:inline-flex;align-items:center;gap:10px;">
        <span class="views">{{ video.views_count or 0 }} views</span>
        {% if video.likes_count %}<span class="likes">{{ video.likes_count }} likes</span>{% endif %}
        {% if video.category %}<span class="category">in {{ video.category }}</span>{% endif %}
      </div>
    </div>
  </div>

  <p>{{ video['description'] }}</p>
</div>

        {% else %}
          <h2 class="watch-title">Video not found</h2>
        {% endif %}

        <!-- (1.1.1) Comments placeholder -->
        <div id="comments-mount-wide">
          <div class="comments-placeholder">
            {% include "comments/block.html" %}
          </div>
        </div>

        <!-- Tabs under player -->
        <section class="watch-tabs" id="watch-tabs" data-active="upnext">
          <div class="tabs-nav" role="tablist" aria-label="Video sections">
            <button id="tab-upnext" role="tab" aria-controls="panel-upnext" aria-selected="true">Up next</button>
            <button id="tab-comments" role="tab" aria-controls="panel-comments" aria-selected="false">Comments</button>
          </div>
          <div class="tab-panels">
            <div id="panel-upnext" class="tab-panel active" role="tabpanel" aria-labelledby="tab-upnext">
              {% if sidebar_list and sidebar_list|length > 0 %}
                <div class="upnext-list" style="display:flex;flex-direction:column;gap:10px;">
                  {% for r in sidebar_list %}
                    {% set vid = r.video_id if r.video_id is defined else r['video_id'] %}
                    {% set title_txt = r.title if r.title is defined else r['title'] %}
                    {% set thumb_static = r.thumb_url if r.thumb_url is defined else r.get('thumb_url') %}
                    {% set thumb_anim = r.thumb_url_anim if r.thumb_url_anim is defined else r.get('thumb_url_anim') %}
                    <a class="rb-item" href="/watch?v={{ vid }}" style="display:flex;gap:8px;text-decoration:none;color:inherit;">
                      <div class="rb-thumb">
                        {% if thumb_static %}<img class="rb-thumb-static" src="{{ thumb_static }}" alt="{{ title_txt }}">{% endif %}
                        {% if thumb_anim %}<img class="rb-thumb-anim" src="{{ thumb_anim }}" alt="{{ title_txt }}">{% endif %}
                      </div>
                      <div class="rb-info" style="min-width:0;">
                        <div class="rb-title" style="font-weight:600;line-height:1.2;max-height:2.4em;overflow:hidden;">{{ title_txt }}</div>
                        <div class="rb-author" style="font-size:12px;color:#666;">{{ r.author or r.username or '' }}</div>
                        <div class="rb-meta" style="font-size:12px;color:#666;">{{ r.views_count or 0 }} views{% if r.uploaded_at %} • {{ r.uploaded_at }}{% endif %}</div>
                      </div>
                    </a>
                  {% endfor %}
                </div>
              {% else %}
                <div>No recommendations.</div>
              {% endif %}
            </div>
<!-- Removed block.html inclusion - there was dupl. new-comment field in short mode -->
			<div id="panel-comments" class="tab-panel" role="tabpanel" aria-labelledby="tab-comments">
			  <div id="comments-mount-narrow">
				<div class="comments-placeholder">
				  <div class="comments-placeholder-inner">No comments..</div>
				</div>
			  </div>
			</div>
          </div>
        </section>
      </div>

      <!-- (1.2) Right slot: to here will moved "up next" -->
      <div class="under-right-slot" id="under-right-slot"></div>
    </div>
  </div>

  {% if _has_right %}
  <aside class="watch-right" aria-label="Up next" id="watch-right">
    <div class="upnext-block" id="upnext-block">
      <h3 style="margin:0 0 8px 0;">Up next</h3>
      <div class="rb-list" style="display:flex;flex-direction:column;gap:10px;">
        {% for r in sidebar_list %}
        <a class="rb-item" href="/watch?v={{ r['video_id'] }}" style="display:flex;gap:8px;text-decoration:none;color:inherit;">
          <div class="rb-thumb">
            {% if r['thumb_url'] %}<img class="rb-thumb-static" src="{{ r['thumb_url'] }}" alt="{{ r['title'] }}">{% endif %}
            {% if r['thumb_url_anim'] %}<img class="rb-thumb-anim" src="{{ r['thumb_url_anim'] }}" alt="{{ r['title'] }}">{% endif %}
          </div>
          <div class="rb-info" style="min-width:0;">
            <div class="rb-title" style="font-weight:600;line-height:1.2;max-height:2.4em;overflow:hidden;">
              {{ r['title'] }}
            </div>
            <div class="rb-author" style="font-size:12px;color:#666;">{{ r['author'] or r['username'] or '' }}</div>
            <div class="rb-meta" style="font-size:12px;color:#666;">
              {{ r['views_count'] or 0 }} views{% if r['uploaded_at'] %} • {{ r['uploaded_at'] }}{% endif %}
            </div>
          </div>
        </a>
        {% endfor %}
      </div>
    </div>
  </aside>
  {% endif %}

</div>

<script defer src="/static/js/video_reactions.js"></script>

<script>
/* Theater detection: mirror .yrp-theater from .yrp-container into .watch-layout */
(function(){
  var layout = document.querySelector(".watch-layout");
  if(!layout) return;

  var moPlayer = null;
  var poll = null;

  function setTheater(flag){
    if(flag) layout.classList.add("theater-mode");
    else layout.classList.remove("theater-mode");
    relocateUpNext();
  }

  function getPlayerRoot(){
    return document.querySelector(".yrp-container") || document.querySelector(".player-host");
  }

  function bindObserver(){
    var host = getPlayerRoot();
    if(!host) return;
    if(moPlayer) try{ moPlayer.disconnect(); }catch(e){}
    moPlayer = new MutationObserver(function(){
      setTheater(host.classList.contains("yrp-theater"));
    });
    moPlayer.observe(host, { attributes:true, attributeFilter:["class"] });
    setTheater(host.classList.contains("yrp-theater"));
  }

  /*  For theater mode: move "up next"into under-right-slot */
  function isNarrow(){ return window.matchMedia('(max-width:1100px)').matches; }
  function relocateUpNext(){
    var block = document.getElementById('upnext-block');
    var aside = document.getElementById('watch-right');
    var slot  = document.getElementById('under-right-slot');
    if (!block || !aside || !slot) return;
    if (layout.classList.contains('theater-mode') && !isNarrow()) {
      if (slot.firstElementChild !== block) slot.appendChild(block);
    } else {
      if (aside && aside.firstElementChild !== block) aside.appendChild(block);
    }
  }
  window.addEventListener('resize', relocateUpNext);

  var moDom = new MutationObserver(function(){ bindObserver(); });
  moDom.observe(document.body, { childList:true, subtree:true });

  poll = setInterval(function(){ bindObserver(); }, 150);

  window.addEventListener("beforeunload", function(){
    try{ moDom.disconnect(); }catch(e){}
    try{ moPlayer && moPlayer.disconnect(); }catch(e){}
    try{ clearInterval(poll); }catch(e){}
  });

  bindObserver();
  relocateUpNext();
})();
</script>
<script>
(function(){
  var wrap = document.getElementById('embed-inline');
  if (!wrap) return;
  var trigger = wrap.querySelector('.embed-trigger');
  var panel   = document.getElementById('embed-flyout');
  var backdrop= document.getElementById('embed-backdrop');
  var btnCopy = wrap.querySelector('.btn-copy-embed');
  var btnClose= wrap.querySelector('.btn-close-embed');
  var textarea= wrap.querySelector('.embed-code');

  function openPanel(){
    if (!panel) return;
    panel.hidden = false;
    trigger.setAttribute('aria-expanded','true');
    if (backdrop) backdrop.hidden = false;
    // autoselect code while opened
    try { textarea && textarea.focus(); textarea && textarea.select(); } catch(e){}
  }
  function closePanel(){
    if (!panel) return;
    panel.hidden = true;
    trigger.setAttribute('aria-expanded','false');
    if (backdrop) backdrop.hidden = true;
  }

  trigger.addEventListener('click', function(e){
    e.stopPropagation();
    if (panel.hidden) openPanel(); else closePanel();
  });
  btnClose && btnClose.addEventListener('click', function(){ closePanel(); });

  // Copy embed text
  btnCopy && btnCopy.addEventListener('click', function(){
    try{
      textarea && textarea.select();
      document.execCommand('copy');
      textarea && textarea.blur();
    }catch(e){}
  });

  // Close by ext. click
  document.addEventListener('click', function(e){
    if (!panel || panel.hidden) return;
    if (wrap.contains(e.target)) return;
    closePanel();
  });
  // Close by Esc
  document.addEventListener('keydown', function(e){
    if (e.key === 'Escape') closePanel();
  });
})();
</script>
<script src="/static/js/comments/comments_api.js"></script>
<script src="/static/js/comments/comments_tree.js"></script>
<script src="/static/js/comments/comments_ui.js"></script>
<script src="/static/js/comments/comments_author_heart.js"></script>
{% endblock %}