{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="/static/css/manage/account_layout.css">

<div class="manage-comments-layout">
  {% include "account/left.html" %}

  <main class="mc-main">
<div style="display:flex; gap:24px; align-items:flex-start; flex-wrap:wrap;">
  <div style="flex:0 0 260px;">
    <h2>Avatar</h2>
    <div style="margin-bottom:12px;">
      {% if avatar_url %}
        <img src="{{ avatar_url }}" alt="avatar" style="width:128px;height:128px;object-fit:cover;border-radius:8px;"
             onerror="this.onerror=null;this.src='/static/img/avatar_default.svg';">
      {% else %}
        <img src="/static/img/avatar_default.svg" alt="avatar" style="width:128px;height:128px;">
      {% endif %}
    </div>
    <form action="/account/profile" method="post" enctype="multipart/form-data" style="margin-bottom:12px;">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
      <input type="file" name="avatar" accept="image/*" required>
      <div style="margin-top:8px;">
        <button type="submit">Upload avatar</button>
      </div>
    </form>
    {% if avatar_url %}
    <form action="/account/avatar/delete" method="post" onsubmit="return confirm('Delete avatar?');">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
      <button type="submit">Delete avatar</button>
    </form>
    {% endif %}
  </div>

  <div style="flex:1; min-width:280px;">
    <h2>Profile</h2>

    {% set sso_name = None %}
    {% for ident in sso_identities %}
      {% if ident.display_name and not sso_name %}
        {% set sso_name = ident.display_name %}
      {% endif %}
    {% endfor %}
    <p>Name: <strong>{{ sso_name if sso_name else current_user['username'] }}</strong></p>

    <ul style="margin-top:16px;">
      <li><a href="/manage">My videos</a></li>
      <li><a href="/subscriptions">My subscriptions</a></li>
      <li><a href="/history">My history</a></li>
      <li><a href="/account/password">Change password</a></li>
    </ul>

    {% if sso_identities and sso_identities|length > 0 %}
      <h3 style="margin-top:28px;">Connected SSO</h3>
      <ul>
        {% for ident in sso_identities %}
          <li>
            {{ ident.provider|capitalize }}:
            {% if ident.display_name %}
              {{ ident.display_name }}
            {% elif ident.email %}
              {{ ident.email }}
            {% else %}
              {{ ident.subject }}
            {% endif %}
            {% if ident.picture_url %}
              <img src="{{ ident.picture_url }}" alt="pic"
                   style="width:32px;height:32px;border-radius:50%;object-fit:cover;vertical-align:middle;margin-left:8px;">
            {% endif %}
          </li>
        {% endfor %}
      </ul>

      {% set has_google = false %}
      {% set has_twitter = false %}
      {% for ident in sso_identities %}
        {% if ident.provider == 'google' %}
          {% set has_google = true %}
        {% elif ident.provider == 'twitter' %}
          {% set has_twitter = true %}
        {% endif %}
      {% endfor %}
      {% set current_authp = request.cookies.get('yt_authp') %}

      {% if has_google and current_authp == 'google' %}
      <form action="/account/sso/google/unlink" method="post" style="margin-top:12px;"
            onsubmit="return confirm('Unlink Google account?');">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <button type="submit">Unlink Google</button>
      </form>
      {% endif %}
    {% else %}
      {# Even if list empty, still detect current auth provider from cookie #}
      {% set has_twitter = false %}
    {% endif %}
  </div>
</div>

  </main>
</div>
{% endblock %}