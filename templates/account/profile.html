{% extends "base.html" %}
{% block content %}
<h1>Account</h1>

{% set msg = request.query_params.get('msg') %}
{% if msg %}
  <div class="alert">
    {% if msg == 'google_unlinked' %}Google account unlinked successfully.
    {% elif msg == 'no_google' %}No Google account linked.
    {% elif msg == 'need_password_before_unlink' %}Set a local password before unlinking Google.
    {% elif msg == 'unlinked' %}Google unlinked and you were logged out.
    {% else %}{{ msg }}
    {% endif %}
  </div>
{% endif %}

<div style="display:flex; flex-wrap:wrap; gap:32px; align-items:flex-start;">
  <div style="flex:0 0 260px;">
    <h2>Avatar</h2>
    <div style="margin:10px 0;">
      {% if avatar_url %}
        <img src="{{ avatar_url }}" alt="avatar" style="width:128px;height:128px;object-fit:cover;border-radius:8px;"
             onerror="this.onerror=null;this.src='/static/img/avatar_default.svg';">
      {% else %}
        <img src="/static/img/avatar_default.svg" alt="avatar" style="width:128px;height:128px;">
      {% endif %}
    </div>
    <form action="/account/profile" method="post" enctype="multipart/form-data" style="margin-bottom:12px;">
      <input type="file" name="avatar" accept="image/*" required>
      <div style="margin-top:8px;">
        <button type="submit">Upload avatar</button>
      </div>
    </form>
    {% if avatar_url %}
    <form action="/account/avatar/delete" method="post" onsubmit="return confirm('Delete avatar?');">
      <button type="submit">Delete avatar</button>
    </form>
    {% endif %}
  </div>

  <div style="flex:1; min-width:280px;">
    <h2>Profile</h2>

    {% set sso_name = None %}
    {% for ident in sso_identities %}
      {% if ident.display_name and not sso_name %}
        {% set sso_name = ident.display_name %}
      {% endif %}
    {% endfor %}
    <p>Name: <strong>{{ sso_name if sso_name else current_user['username'] }}</strong></p>

    <ul style="margin-top:16px;">
      <li><a href="/manage">My videos</a></li>
      <li><a href="/subscriptions">My subscriptions</a></li>
      <li><a href="/history">My history</a></li>
      <li><a href="/account/password">Change password</a></li>
    </ul>

    {% if sso_identities and sso_identities|length > 0 %}
      <h3 style="margin-top:28px;">Connected SSO</h3>
      <ul>
        {% for ident in sso_identities %}
          <li>
            {{ ident.provider|capitalize }}:
            {% if ident.display_name %}
              {{ ident.display_name }}
            {% elif ident.email %}
              {{ ident.email }}
            {% else %}
              {{ ident.subject }}
            {% endif %}
            {% if ident.picture_url %}
              <img src="{{ ident.picture_url }}" alt="pic"
                   style="width:32px;height:32px;border-radius:50%;object-fit:cover;vertical-align:middle;margin-left:8px;">
            {% endif %}
          </li>
        {% endfor %}
      </ul>

      {% set has_google = false %}
      {% set has_twitter = false %}
      {% for ident in sso_identities %}
        {% if ident.provider == 'google' %}
          {% set has_google = true %}
        {% elif ident.provider == 'twitter' %}
          {% set has_twitter = true %}
        {% endif %}
      {% endfor %}
      {% set current_authp = request.cookies.get('yt_authp') %}

      {% if has_google and current_authp == 'google' %}
      <form action="/account/sso/google/unlink" method="post" style="margin-top:12px;"
            onsubmit="return confirm('Unlink Google account?');">
        <button type="submit">Unlink Google</button>
      </form>
      {% endif %}
    {% else %}
      {# Even if list empty, still detect current auth provider from cookie #}
      {% set has_twitter = false %}
      {% set has_google = false %}
      {% set current_authp = request.cookies.get('yt_authp') %}
    {% endif %}

    <div style="margin-top:16px;">
      {# Hide Link Twitter if twitter identity already exists OR current login is via twitter (cookie) #}
      {% if not has_twitter and current_authp != 'twitter' %}
        <a class="button" href="/auth/twitter/start?link=1">Link Twitter</a>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}