{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="/static/css/manage/account_layout.css">
<link rel="stylesheet" href="/static/css/manage/video_translations.css">

<div class="manage-comments-layout" data-video-id="{{ video_id }}">
  {% include "account/left.html" %}
  <main class="mc-main">
    <div class="mc-top-bar">
      <h1 class="mc-page-title">Translations</h1>
      <div class="mc-back-link">
        <a href="/manage/video/{{ video_id }}/media">Back to Media</a>
      </div>
    </div>

    {% if not has_captions %}
      <div class="alert alert-error" style="margin-top:10px;">
        Primary captions file not found. Generate captions first.
      </div>
      <p style="margin-top:10px;">
        Go to <a href="/manage/video/{{ video_id }}/media">Media tools</a> and generate captions.
      </p>
    {% else %}
      <section style="margin-top:16px;">
        <h2>Available target languages</h2>

        {% if yttrans_meta and yttrans_meta.error %}
          <div class="alert alert-error" style="margin-bottom:10px;">
            Failed to fetch languages: {{ yttrans_meta.error }}
          </div>
        {% endif %}

        {% if target_langs %}
          <div style="font-size:12px; color:#555; margin-bottom:6px;">
		    Provider: <code>{{ yttrans_meta["engine"] }}</code><br>
		    Model: <code>{{ yttrans_meta["model"] or "unknown" }}</code><br>
		    Device: <code>{{ yttrans_meta["device"] or "unknown" }}</code><br>
		    Server: <code>{{ yttrans_meta["host"] or "unknown" }}:{{ yttrans_meta["port"] or "0" }}</code><br>
		    Langs amount: <code>{{ target_langs|length or 0 }}</code><br>
            Default source lang: <code>{{ default_source_lang }}</code>
          </div>

          <form id="form-translations" method="post">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

            <ul id="langs-list" style="list-style:none; padding:0; display:flex; flex-wrap:wrap; gap:10px;">
              {% for lang in target_langs %}
                {% set code = lang.code %}
                {% set label = lang.name %}
                {% set has_file = (existing_langs and (code in existing_langs)) %}
                <li data-lang="{{ code }}"
                    class="{{ 'lang-has-file' if has_file else '' }}"
                    style="border:1px solid #ddd; padding:6px 8px; border-radius:6px;">
                  <label style="display:flex; align-items:center; gap:8px;">
                    <input type="checkbox" name="lang" value="{{ code }}">
                    <span style="font-weight:600;">{{ label }}</span>
                    <span style="font-size:11px; opacity:.75;">({{ code }})</span>
                    <a class="lang-edit {{ '' if has_file else 'disabled' }}"
                       href="{{ '' if not has_file else '/manage/video/' ~ video_id ~ '/vtt/edit?rel_vtt=captions/' ~ code ~ '.vtt' }}"
                       title="Edit" aria-label="Edit" style="font-size:14px; line-height:1; margin-left:4px;">✏️</a>
                    <a class="lang-dl {{ '' if has_file else 'disabled' }}"
                       href="{{ '' if not has_file else '/manage/video/' ~ video_id ~ '/vtt/download?rel_vtt=captions/' ~ code ~ '.vtt' }}"
                       title="Download" aria-label="Download" style="font-size:14px; line-height:1; margin-left:4px;">&#128190;</a>
                  </label>
                </li>
              {% endfor %}
            </ul>

            <div style="margin-top:8px;">
              <button type="submit"
                      formaction="/manage/video/{{ video_id }}/translations/generate"
                      title="Generate selected translations">Generate</button>
              <button type="submit"
                      formaction="/manage/video/{{ video_id }}/translations/delete"
                      style="margin-left:8px;"
                      title="Delete selected translations">Delete</button>
			  <button type="submit"
                      formaction="/manage/video/{{ video_id }}/translations/reset_all"
                      style="margin-left:8px; background:#b00020; color:#fff;"
                      title="Delete ALL translations and reset translation job"
                      onclick="return confirm('Reset ALL translations for this video? This will delete all translated VTT files and reset translations.meta.json.');">
                Reset All
              </button>
              <span id="trans-status" style="margin-left:10px;font-size:12px;color:#555;"></span>
            </div>
          </form>
        {% else %}
          <p>No languages reported by the translation service.</p>
        {% endif %}
      </section>
    {% endif %}
  </main>
</div>

<script src="/static/js/translations_status.js"></script>
{% endblock %}