{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="/static/css/manage/account_layout.css">

<div class="manage-comments-layout">
  {% include "account/left.html" %}
  <main class="mc-main" data-video-id="{{ video_id }}">
    <div class="mc-top-bar">
      <h1 class="mc-page-title">Media: Sprites & Subtitles</h1>
      <div class="mc-back-link">
        <a href="/manage">Back to My Videos</a>
      </div>
    </div>

    <section>
      <h2 style="margin-top:0;">Current assets</h2>
      <ul style="list-style:none; padding-left:0;">
        {% if assets.thumb_url %}
        <li>Thumbnail: <img src="{{ assets.thumb_url }}" alt="thumb" style="height:60px; vertical-align:middle;"></li>
        {% endif %}
        {% if assets.thumbs_vtt %}
        <li>Thumbs VTT: <a href="{{ assets.thumbs_vtt }}" target="_blank"><code>{{ assets.thumbs_vtt }}</code></a></li>
        {% endif %}
        {% if assets.captions_vtt %}
        {% set rel_vtt = assets.captions_vtt %}
        {% if assets.storage_path %}
          {% set prefix = '/storage/' ~ assets.storage_path ~ '/' %}
          {% if rel_vtt.startswith(prefix) %}
            {% set rel_vtt = rel_vtt[prefix|length:] %}
          {% endif %}
        {% endif %}
        <li>Captions VTT (primary): <code>{{ assets.captions_vtt }}</code></li>
        {% endif %}
        {% if assets.sprites and assets.sprites|length > 0 %}
        <li>Sprites:
          <div class="sprite-list" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:6px;">
            {% for sp in assets.sprites %}
              <div class="sprite-item" style="border:1px solid #ddd;padding:4px;">
                <a href="{{ sp }}" target="_blank">
                  <img src="{{ sp }}" alt="sprite" style="height:90px;">
                </a>
              </div>
            {% endfor %}
          </div>
        </li>
        {% endif %}
      </ul>

      <form id="ytms-start-form"
            action="/manage/video/{{ video_id }}/media/process"
            method="post"
            data-video-id="{{ video_id }}"
            novalidate
            style="margin-bottom:12px;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <button id="ytms-start" type="submit">Generate sprites & subtitles</button>
        <span id="ytms-status" style="margin-left:12px; font-size:13px;"></span>
      </form>

      {% if assets.thumbs_vtt %}
      <form id="ytms-retry-form"
            action="/internal/ytms/thumbnails/retry"
            method="post"
            data-video-id="{{ video_id }}"
            style="margin-bottom:4px;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <input type="hidden" name="video_id" value="{{ video_id }}">
        <button id="ytms-retry" type="submit">Regenerate thumbnails</button>
        <span id="ytms-retry-status" style="margin-left:12px; font-size:13px;"></span>
      </form>
      {% endif %}
      <div id="ytms-result" style="margin-top:16px; font-size:13px;"></div>
    </section>

    {% if assets.thumbs_vtt and assets.sprites and assets.sprites|length > 0 %}
    <section style="margin-top:24px;">
      <h2>Preview test</h2>
      <p>Hover the area below to see sprite preview extracted from VTT.</p>
      <div id="preview-area"
           data-vtt="{{ assets.thumbs_vtt }}"
           style="width:600px;height:80px;border:1px dashed #999;position:relative;background:#fafafa;">
        <div id="preview-pop"
             style="display:none;position:absolute;top:-110px;left:0;width:160px;height:90px;border:1px solid #333;background:#000;color:#fff;font-size:11px;align-items:center;justify-content:center;overflow:hidden;">
        </div>
      </div>
    </section>
    {% endif %}

	<section style="margin-top:24px;">
	  <h2>Captions</h2>

      <div class="alert" style="font-size:13px; white-space:pre-line; margin-bottom:10px;">
Set lang code in ISO format (2 symbols), or
auto - to detect lang automatically, or
mixed - if you sure that video with voice on several langs.
NOTE: Captions generation may take a long time.
      </div>

	  {% if assets.captions_vtt %}
		<p>Primary captions track detected.</p>
		<form id="form-retry-captions" action="/internal/ytcms/captions/retry" method="post" style="margin-top:8px;">
		  <input type="hidden" name="video_id" value="{{ video_id }}">
		  <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
		  <label style="font-size:12px;">Lang (auto or code): <input name="lang" value="{{ assets.captions_lang or 'auto' }}" style="width:90px;"></label>
		  <button id="btn-generate-captions" type="submit">Regenerate captions</button>
          <span id="captions-status" data-video-id="{{ video_id }}" style="margin-left:10px;font-size:12px;color:#555;"></span>
		</form>
        <form action="/internal/ytcms/captions/delete" method="post" style="margin-top:6px;">
          <input type="hidden" name="video_id" value="{{ video_id }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <button type="submit">Delete captions</button>
        </form>
	  {% else %}
		<p>No primary captions track (generate first).</p>
		<form id="form-start-captions" action="/manage/video/{{ video_id }}/captions/process" method="post" style="margin-top:8px;">
		  <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
		  <label style="font-size:12px;">Lang (auto or code): <input name="lang" value="auto" style="width:90px;"></label>
		  <button id="btn-generate-captions" type="submit">Generate captions</button>
          <span id="captions-status" data-video-id="{{ video_id }}" style="margin-left:10px;font-size:12px;color:#555;"></span>
		</form>
        <form action="/internal/ytcms/captions/delete" method="post" style="margin-top:6px;">
          <input type="hidden" name="video_id" value="{{ video_id }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <button type="submit">Delete captions</button>
        </form>
	  {% endif %}
	</section>
  </main>
</div>

<script src="/static/js/ytms.js"></script>
<script src="/static/js/sprite_preview.js"></script>
<script src="/static/js/captions_status.js"></script>
<script>
(function(){
  var el = document.getElementById('captions-status');
  if (el && window.CaptionsStatus) {
    // Set "processing (0%)" just button pressed
    var formStart = document.getElementById('form-start-captions');
    var formRetry = document.getElementById('form-retry-captions');
    function setProcessingInstant(){
      try {
        window.CaptionsStatus.setImmediateProcessing(el);
      } catch (_) {}
    }
    if (formStart) {
      formStart.addEventListener('submit', setProcessingInstant);
    }
    if (formRetry) {
      formRetry.addEventListener('submit', setProcessingInstant);
    }

    window.CaptionsStatus.init({
      el: el,
      videoId: el.getAttribute('data-video-id'),
      intervalMs: 6000
    });
  }
})();
</script>
{% endblock %}