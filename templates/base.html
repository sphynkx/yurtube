<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>YurTube</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
<script defer src="/static/js/csrf_fetch.js"></script>
  <!-- Core styles -->
  <link href="/static/css/main.css" rel="stylesheet">
  <link href="/static/css/brand.css" rel="stylesheet">
  <link href="/static/css/side-menu.css" rel="stylesheet">
  <!-- Notifications styles -->
  <link href="/static/css/notifications.css" rel="stylesheet">


  {# Brand assets are passed in every template context (fallbacks already handled in settings) #}
  {% set _brand_logo = brand_logo_url %}
  {% if _brand_logo and (not _brand_logo.startswith('http') and not _brand_logo.startswith('/')) %}
    {% set _brand_logo = '/' ~ _brand_logo %}
  {% endif %}

  {% set _favicon = favicon_url %}
  {% if _favicon and (not _favicon.startswith('http') and not _favicon.startswith('/')) %}
    {% set _favicon = '/' ~ _favicon %}
  {% endif %}

  {% set _apple_icon = apple_touch_icon_url %}
  {% if _apple_icon and (not _apple_icon.startswith('http') and not _apple_icon.startswith('/')) %}
    {% set _apple_icon = '/' ~ _apple_icon %}
  {% endif %}

  <link rel="icon" type="image/png" sizes="32x32" href="{{ _favicon }}">
  <link rel="apple-touch-icon" href="{{ _apple_icon }}">

  <style>
    :root { --brand-accent: #2aa4ff; }

    .site-header {
      position: sticky;
      top: 0;
      z-index: 1002;
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:center;
      padding:4px 12px 20px;
      background:#fff;
    }

    .brand-block {
      display:flex;
      flex-direction:column;
      gap:4px;
      flex:0 0 auto;
    }
    .brand-line {
      display:flex;
      align-items:center;
      gap:12px;
    }

    .btn-hamburger {
      display:inline-flex; align-items:center; justify-content:center;
      width:44px; height:44px;
      background:transparent; border:0; cursor:pointer; border-radius:6px;
    }
    .btn-hamburger:hover { background: rgba(42,164,255,.10); }
    .btn-hamburger .bars,
    .btn-hamburger .bars::before,
    .btn-hamburger .bars::after { background: var(--brand-accent); }
    .btn-hamburger .bars { position:relative; width:26px; height:3px; border-radius:2px; }
    .btn-hamburger .bars::before,
    .btn-hamburger .bars::after { content:""; position:absolute; left:0; width:26px; height:3px; border-radius:2px; }
    .btn-hamburger .bars::before { top:-8px; }
    .btn-hamburger .bars::after  { top: 8px; }

    .logo { display:flex; align-items:center; gap:12px; flex:0 0 auto; }

    .brand-tagline {
      color: var(--brand-accent);
      font-weight: 600;
      font-size: 20px;
      line-height: 1.2;
      letter-spacing: .2px;
      margin-top: 2px;
    }

    .search-form { flex:1 1 360px; display:flex; }
    .user-nav { display:flex; align-items:center; flex:0 0 auto; }

    @media (max-width: 760px) {
      .site-header { align-items:flex-start; }
      .user-nav { margin-left:8px; }
      .search-form { flex:1 1 100%; width:100%; }
      .brand-tagline { font-size: 16px; }
    }
    @media (max-width: 480px) {
      .search-form input { width:100%; }
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="brand-block">
      <div class="brand-line">
        <button id="btn-toggle-topmenu"
                class="btn-hamburger"
                aria-label="Open menu"
                aria-controls="top-menu-panel"
                aria-expanded="false">
          <span class="bars" aria-hidden="true"></span>
        </button>

        <div class="logo">
          <a href="/" aria-label="YurTube home">
            <img class="brand-logo" src="{{ _brand_logo }}" alt="YurTube">
          </a>
        </div>
      </div>

      {% if brand_tagline %}
        <div class="brand-tagline">{{ brand_tagline }}</div>
      {% endif %}
    </div>

    <form class="search-form" action="/search" method="get">
      <input type="text" name="q" placeholder="Search" aria-label="Search">
    </form>

    <nav class="user-nav">
      {% if current_user %}
        {% set authp = request.cookies.get('yt_authp') %}
        {% set sso_pic = request.cookies.get('yt_gpic') %}
        {% set sso_name_raw = request.cookies.get('yt_gname') %}
        {% set sso_name = sso_name_raw.replace('+',' ') if sso_name_raw else None %}
        {% set local_name_raw = request.cookies.get('yt_lname') %}
        {% set local_name = local_name_raw.replace('+',' ') if local_name_raw else None %}

        {# Build avatar URL via backend helper (passed in context in most routes) #}
		{# Build avatar URL: prefer SSO picture; otherwise resolve storage-relative path #}
		{% set avatar_src = '/static/img/avatar_default.svg' %}
		{% if current_user['user_uid'] %}
		  {% set _avatar_rel = 'users/' ~ current_user['user_uid'] ~ '/avatar_small.png' %}
		  {# If there is a public base (local mode or external CDN), use it; else use internal proxy path-form #}
		  {% if storage_public_base_url %}
			{% set avatar_src = storage_public_base_url ~ '/' ~ _avatar_rel %}
		  {% else %}
			{# Remote mode: use internal proxy path-form so VTT/relative paths resolve properly #}
			{% set avatar_src = '/internal/storage/file/' ~ _avatar_rel %}
		  {% endif %}
		{% endif %}
		{% if authp and authp != 'local' and sso_pic %}
		  {% set avatar_src = sso_pic %}
		{% endif %}

        {% set display_name = current_user['username'] %}
        {% if authp == 'local' and local_name %}
          {% set display_name = local_name %}
        {% elif authp and authp != 'local' and sso_name %}
          {% set display_name = sso_name %}
        {% endif %}

        {# Notifications bell #}
        {% include "partials/notifications_bell.html" %}

        <details class="user-menu">
          <summary style="display:inline-flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;">
            <img id="nav-avatar" src="{{ avatar_src }}" alt="me" class="avatar"
                 onerror="this.onerror=null;this.src='/static/img/avatar_default.svg';"
                 style="width:32px;height:32px;border-radius:50%;object-fit:cover;">
            <span title="{{ display_name }}"
                  style="display:block;font-weight:600;font-size:12px;line-height:1;text-align:center;width:140px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
              {{ display_name }}
            </span>
          </summary>
          <ul>
            <li><a href="/account">Account</a></li>
            <li><a href="/manage">My videos</a></li>
            <li><a href="/subscriptions">My subscriptions</a></li>
            <li><a href="/history">My history</a></li>
            <li class="menu-sep"><hr></li>
            <li><a href="/upload">Upload</a></li>
            <li class="menu-sep"><hr></li>
            <li>
              <form action="/auth/logout?csrf_token={{ csrf_token or request.cookies.get('yt_csrf') or '' }}" method="post" style="display:inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token or request.cookies.get('yt_csrf') or '' }}">
                <button type="submit">Logout</button>
              </form>
            </li>
          </ul>
        </details>
      {% else %}
        <details class="user-menu">
          <summary style="display:inline-flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;">
            <img src="/static/img/avatar_default.svg" alt="guest" class="avatar"
                 style="width:32px;height:32px;border-radius:50%;object-fit:cover;">
            <span title="Guest"
                  style="display:block;font-weight:600;font-size:12px;line-height:1;text-align:center;width:140px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
              Guest
            </span>
          </summary>
          <ul>
            <li><a href="/auth/login">Login</a></li>
            <li><a href="/auth/register">Register</a></li>
          </ul>
        </details>
      {% endif %}
    </nav>
  </header>

  <!-- Top dropdown panel + overlay -->
  <div id="menu-overlay" class="menu-overlay" aria-hidden="true" tabindex="-1"></div>
  <div id="top-menu-panel" class="top-menu-panel" aria-hidden="true" aria-label="Main navigation">
    {% include "partials/side_menu.html" %}
  </div>

  <div class="layout">
    <main class="content">
      {% block content %}{% endblock %}
    </main>
  </div>

  <!-- Brython (legacy code still used) -->
  <script defer src="https://cdn.jsdelivr.net/npm/brython@3.13.0/brython.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/brython@3.13.0/brython_stdlib.js"></script>
  <script type="text/python" src="/static/brython/init.bry"></script>

  <!-- Notifications JS -->
  <script defer src="/static/js/notifications_bell.js"></script>

  <script>
    window.addEventListener("DOMContentLoaded", function () {
      try { if (window.brython) { brython({debug: 1}); } } catch (e) {}
    });

    (function(){
      var panel   = document.getElementById('top-menu-panel');
      var overlay = document.getElementById('menu-overlay');
      var btn     = document.getElementById('btn-toggle-topmenu');
      var header  = document.querySelector('.site-header');
      var lastFocus = null;

      function clamp(n,a,b){ return Math.max(a, Math.min(n,b)); }
      function logoWidth(){
        var logo = document.querySelector('.brand-logo');
        if(!logo) return 280;
        var r = logo.getBoundingClientRect();
        return clamp(Math.round(r.width||logo.offsetWidth||280), 220, 480);
      }
      function setMetrics(){
        if(!panel || !overlay) return;
        var w = logoWidth();
        panel.style.width = w+'px';
        var hb = header ? header.getBoundingClientRect().bottom : 56;
        panel.style.top = Math.round(hb)+'px';
        panel.style.left = '12px';
        overlay.style.setProperty('--overlay-top', Math.round(hb)+'px');
      }

      function openPanel(){
        if(panel.classList.contains('open')) return;
        lastFocus = document.activeElement;
        setMetrics();
        panel.classList.add('open');
        overlay.classList.add('open');
        panel.setAttribute('aria-hidden','false');
        overlay.setAttribute('aria-hidden','false');
        if(btn) btn.setAttribute('aria-expanded','true');
      }
      function closePanel(){
        if(!panel.classList.contains('open')) return;
        panel.classList.remove('open');
        overlay.classList.remove('open');
        panel.setAttribute('aria-hidden','true');
        overlay.setAttribute('aria-hidden','true');
        if(btn) btn.setAttribute('aria-expanded','false');
        try { if(lastFocus) lastFocus.focus(); } catch(e){}
      }
      function togglePanel(){ panel.classList.contains('open') ? closePanel() : openPanel(); }

      if(btn) btn.addEventListener('click', togglePanel);
      if(overlay) overlay.addEventListener('click', closePanel);

      // Close by click on header (except menu triggers)
      if(header){
        header.addEventListener('click', function(e){
          if(!panel.classList.contains('open')) return;
          if(e.target.closest('#btn-toggle-topmenu')) return;
          if(e.target.closest('#top-menu-panel')) return;
          if(e.target.closest('.user-menu')) return;
          if(e.target.closest('#notif-bell-wrap')) return;
          closePanel();
        });
      }

      window.addEventListener('resize', function(){
        if(panel.classList.contains('open')) setMetrics();
      });
      setMetrics();
    })();

    // Watch page tabs (legacy)
    (function(){
      var tabsRoot = document.getElementById('watch-tabs');
      if(!tabsRoot) return;
      document.addEventListener('click', function(e){
        var t = e.target.closest('[role="tab"]');
        if(!t || !tabsRoot.contains(t)) return;
        e.preventDefault();
        var targetId = t.getAttribute('data-target') || t.getAttribute('aria-controls');
        if(!targetId) return;
        document.querySelectorAll('.tab-panel').forEach(function(p){
          p.classList.toggle('active', p.id === targetId);
        });
        tabsRoot.querySelectorAll('[role="tab"]').forEach(function(tab){
          var id = tab.getAttribute('data-target') || tab.getAttribute('aria-controls');
          tab.setAttribute('aria-selected', String(id === targetId));
        });
        tabsRoot.dataset.active = targetId.indexOf('comments') !== -1 ? 'comments' : 'upnext';
      });
    })();
  </script>
</body>
</html>