<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>YurTube</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="/static/css/main.css" rel="stylesheet">
  <link href="/static/css/brand.css" rel="stylesheet">

  {% set _brand_logo = brand_logo_url if brand_logo_url else '/static/img/YT_long.png' %}
  {% if _brand_logo and (not _brand_logo.startswith('http') and not _brand_logo.startswith('/')) %}
    {% set _brand_logo = '/' ~ _brand_logo %}
  {% endif %}

  {% set _favicon = favicon_url if favicon_url else '/static/img/YT_fav32.png' %}
  {% if _favicon and (not _favicon.startswith('http') and not _favicon.startswith('/')) %}
    {% set _favicon = '/' ~ _favicon %}
  {% endif %}

  {% set _apple_icon = apple_touch_icon_url if apple_touch_icon_url else '/static/img/YT_fav128.png' %}
  {% if _apple_icon and (not _apple_icon.startswith('http') and not _apple_icon.startswith('/')) %}
    {% set _apple_icon = '/' ~ _apple_icon %}
  {% endif %}

  <link rel="icon" type="image/png" sizes="32x32" href="{{ _favicon }}">
  <link rel="apple-touch-icon" href="{{ _apple_icon }}">

  <style>
    /* Wide layout: logo (left) — search (flex) — avatar (right) */
    .site-header {
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:center;
      padding:4px 12px 6px;
    }
    .site-header .logo {
      display:flex;
      align-items:center;
      gap:12px;
      flex:0 0 auto;
      order:1;
    }
    .search-form {
      flex:1 1 360px;
      display:flex;
      order:2;           /* search stays between logo and avatar on wide screens */
    }
    .user-nav {
      display:flex;
      align-items:center;
      flex:0 0 auto;
      order:3;           /* avatar at the right end on wide screens */
      margin-left:0;
    }

    @media (max-width: 760px) {
      .site-header { align-items:flex-start; }
      .logo { order:1; }
      .user-nav {
        order:2;
        margin-left:8px;
      }
      .search-form {
        order:4;
        flex:1 1 100%;
        width:100%;
      }
    }

    @media (max-width: 480px) {
      .search-form input { width:100%; }
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="logo">
      <a href="/" aria-label="YurTube home">
        <img class="brand-logo" src="{{ _brand_logo }}" alt="YurTube">
      </a>
      {% if brand_tagline %}
        <div class="brand-tagline">{{ brand_tagline }}</div>
      {% endif %}
    </div>

    <form class="search-form" action="/search" method="get">
      <input type="text" name="q" placeholder="Search" aria-label="Search">
    </form>

    <nav class="user-nav">
      {% if current_user %}
        {% set authp = request.cookies.get('yt_authp') %}
        {% set sso_pic = request.cookies.get('yt_gpic') %}
        {% set sso_name_raw = request.cookies.get('yt_gname') %}
        {% set sso_name = sso_name_raw.replace('+',' ') if sso_name_raw else None %}
        {% set local_name_raw = request.cookies.get('yt_lname') %}
        {% set local_name = local_name_raw.replace('+',' ') if local_name_raw else None %}

        {% set avatar_src = '/storage/users/' ~ current_user['user_uid'] ~ '/avatar_small.png' %}
        {% if authp and authp != 'local' and sso_pic %}
          {% set avatar_src = sso_pic %}
        {% endif %}

        {% set display_name = current_user['username'] %}
        {% if authp == 'local' and local_name %}
          {% set display_name = local_name %}
        {% elif authp and authp != 'local' and sso_name %}
          {% set display_name = sso_name %}
        {% endif %}

        <details class="user-menu">
          <summary style="display:inline-flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;">
            <img id="nav-avatar" src="{{ avatar_src }}" alt="me" class="avatar"
                 onerror="this.onerror=null;this.src='/static/img/avatar_default.svg';"
                 style="width:32px;height:32px;border-radius:50%;object-fit:cover;">
            <span title="{{ display_name }}"
                  style="display:block;font-weight:600;font-size:12px;line-height:1;text-align:center;width:140px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
              {{ display_name }}
            </span>
          </summary>
          <ul>
            <li><a href="/account">Account</a></li>
            <li><a href="/manage">My videos</a></li>
            <li><a href="/subscriptions">My subscriptions</a></li>
            <li><a href="/history">My history</a></li>
            <li class="menu-sep"><hr></li>
            <li><a href="/upload">Upload</a></li>
            <li class="menu-sep"><hr></li>
            <li>
              <form action="/auth/logout" method="post" style="display:inline">
                <button type="submit">Logout</button>
              </form>
            </li>
          </ul>
        </details>
      {% else %}
        <details class="user-menu">
          <summary style="display:inline-flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;">
            <img src="/static/img/avatar_default.svg" alt="guest" class="avatar"
                 style="width:32px;height:32px;border-radius:50%;object-fit:cover;">
            <span title="Guest"
                  style="display:block;font-weight:600;font-size:12px;line-height:1;text-align:center;width:140px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
              Guest
            </span>
          </summary>
          <ul>
            <li><a href="/auth/login">Login</a></li>
            <li><a href="/auth/register">Register</a></li>
          </ul>
        </details>
      {% endif %}
    </nav>
  </header>

  <div class="layout">
    <aside class="sidebar">
      <ul>
        <li><a href="/">Home</a></li>
        <li><a href="/trending">Trending</a></li>
        <li><a href="/subscriptions">Subscriptions</a></li>
        <li><a href="/history">History</a></li>
      </ul>
    </aside>
    <main class="content">
      {% block content %}{% endblock %}
    </main>
  </div>

  <script defer src="https://cdn.jsdelivr.net/npm/brython@3.13.0/brython.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/brython@3.13.0/brython_stdlib.js"></script>
  <script type="text/python" src="/static/brython/init.bry"></script>
  <script>
    window.addEventListener("DOMContentLoaded", function () {
      try { if (window.brython) { brython({debug: 1}); } } catch (e) {}
    });
  </script>
</body>
</html>