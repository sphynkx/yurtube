<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>YurTube</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="/static/css/main.css" rel="stylesheet">
  <link href="/static/css/brand.css" rel="stylesheet">
  <link rel="icon" type="image/png" sizes="32x32" href="{{ favicon_url|default('/static/img/YT_fav32.png') }}">
  <link rel="apple-touch-icon" href="{{ apple_touch_icon_url|default('/static/img/YT_fav128.png') }}">
</head>
<body>
  <header class="site-header">
    <div class="logo">
      <a href="/" aria-label="YurTube home">
        <img class="brand-logo" src="{{ brand_logo_url|default('/static/img/YT_long.png') }}" alt="YurTube">
      </a>
      {% if brand_tagline %}
        <div class="brand-tagline">{{ brand_tagline }}</div>
      {% endif %}
    </div>
    <form class="search-form" action="/search" method="get">
      <input type="text" name="q" placeholder="Search" aria-label="Search">
    </form>
    <nav class="user-nav">
      {% if current_user %}
        {% set authp = request.cookies.get('yt_authp') %}
        {% set gpic = request.cookies.get('yt_gpic') %}
        {% set gname_raw = request.cookies.get('yt_gname') %}
        {% set gname = gname_raw.replace('+',' ') if gname_raw else None %}

        {% set avatar_src = '/storage/users/' ~ current_user['user_uid'] ~ '/avatar_small.png' %}
        {% if authp == 'google' and gpic %}
          {% set avatar_src = gpic %}
        {% endif %}

        {% set display_name = current_user['username'] %}
        {% if authp == 'google' and gname %}
          {% set display_name = gname %}
        {% endif %}

        <details class="user-menu">
          <summary style="display:inline-flex;align-items:center;gap:8px;">
            <img id="nav-avatar" src="{{ avatar_src }}" alt="me" class="avatar"
                 onerror="this.onerror=null;this.src='/static/img/avatar_default.svg';"
                 style="width:28px;height:28px;border-radius:50%;object-fit:cover;">
            <span style="font-weight:600;max-width:18ch;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
              {{ display_name }}
            </span>
          </summary>
          <ul>
            <li><a href="/account">Account</a></li>
            <li><a href="/manage">My videos</a></li>
            <li><a href="/subscriptions">My subscriptions</a></li>
            <li><a href="/history">My history</a></li>
            <li class="menu-sep"><hr></li>
            <li><a href="/upload">Upload</a></li>
            <li class="menu-sep"><hr></li>
            <li>
              <form action="/auth/logout" method="post" style="display:inline">
                <button type="submit">Logout</button>
              </form>
            </li>
          </ul>
        </details>
      {% else %}
        <a href="/auth/login">Login</a>
        <a href="/auth/register">Register</a>
      {% endif %}
    </nav>
  </header>

  <div class="layout">
    <aside class="sidebar">
      <ul>
        <li><a href="/">Home</a></li>
        <li><a href="/trending">Trending</a></li>
        <li><a href="/subscriptions">Subscriptions</a></li>
        <li><a href="/history">History</a></li>
      </ul>
    </aside>
    <main class="content">
      {% block content %}{% endblock %}
    </main>
  </div>

  <!-- Brython runtime -->
  <script defer src="https://cdn.jsdelivr.net/npm/brython@3.13.0/brython.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/brython@3.13.0/brython_stdlib.js"></script>

  <script type="text/python" src="/static/brython/init.bry"></script>

  <script>
    window.addEventListener("DOMContentLoaded", function () {
      try { if (window.brython) { brython({debug: 1}); } } catch (e) { console.error(e); }
    });
  </script>
</body>
</html>