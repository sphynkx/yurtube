syntax = "proto3";

package ytconvert.v1;

import "google/protobuf/struct.proto";

// ------------------------------------------------------------
// Storage-driven IO refs (ytstorage)
// ------------------------------------------------------------

message StorageRef {
  // gRPC host:port of ytstorage
  string address = 1;

  // reserved for future
  bool tls = 2;

  // bearer token for ytstorage
  string token = 3;
}

message SourceRef {
  StorageRef storage = 1;

  // path relative to storage root, e.g. "RV/RVxxxx/original.webm"
  string rel_path = 2;
}

message OutputRef {
  StorageRef storage = 1;

  // base directory (rel) where to put results (same as original folder)
  // e.g. "RV/RVxxxx"
  string base_rel_dir = 2;
}

// ------------------------------------------------------------
// Common
// ------------------------------------------------------------

message JobAck {
  string job_id = 1;
  bool accepted = 2;
  string message = 3;
  google.protobuf.Struct meta = 4;
}

message ErrorInfo {
  string code = 1;
  string message = 2;
  google.protobuf.Struct meta = 3;
}

message VariantSpec {
  string variant_id = 1;
  string label = 2;

  enum Kind {
    KIND_UNSPECIFIED = 0;
    VIDEO = 1;
    AUDIO = 2;
    HLS = 3;
    DASH = 4;
    OTHER = 10;
  }
  Kind kind = 3;

  // desired container/ext, e.g. "mp4", "webm", "m4a", "mp3", "ogg"
  string container = 4;

  int32 height = 5;
  string vcodec = 6;
  string acodec = 7;
  int32 audio_bitrate_kbps = 8;

  google.protobuf.Struct options = 20;
}

message Status {
  enum State {
    STATE_UNSPECIFIED = 0;
    QUEUED = 1;
    RUNNING = 2;
    DONE = 3;
    FAILED = 4;
    CANCELED = 5;
  }

  string job_id = 1;
  string video_id = 2;
  State state = 3;
  int32 percent = 4;               // 0..100
  string message = 5;
  google.protobuf.Struct meta = 6; // { "stage":"DOWNLOAD|PROBE|ENCODE|UPLOAD", "variant":"...", ... }
  ErrorInfo error = 7;
}

message SubmitConvertRequest {
  string video_id = 1;

  // Optional: retries-safe key (best-effort)
  string idempotency_key = 2;

  // Storage-driven input and output
  SourceRef source = 3;
  OutputRef output = 4;

  repeated VariantSpec variants = 5;

  google.protobuf.Struct options = 6; // priority, keep_intermediate, etc.
}

message GetStatusRequest {
  string job_id = 1;
}

// incremental progress (ready variants)
message GetPartialResultRequest {
  string job_id = 1;
}

message PartialConvertResult {
  string job_id = 1;
  string video_id = 2;
  Status.State state = 3;
  int32 percent = 4;
  string message = 5;

  repeated string ready_variant_ids = 6;
  int32 total_variants = 7;

  google.protobuf.Struct meta = 8;
  ErrorInfo error = 9;
}

// ------------------------------------------------------------
// Results
// ------------------------------------------------------------

message GetResultRequest {
  string job_id = 1;
}

message ArtifactRef {
  string artifact_id = 1;  // e.g. "main"
  string filename = 2;
  string mime = 3;
  int64 size_bytes = 4;
  bytes sha256 = 5;

  // Storage-driven: where it was written
  string rel_path = 6;

  google.protobuf.Struct meta = 10;
}

message VariantResult {
  string variant_id = 1;
  string label = 2;
  repeated ArtifactRef artifacts = 3;
  google.protobuf.Struct meta = 10;
}

message ConvertResult {
  string job_id = 1;
  string video_id = 2;

  Status.State state = 3; // DONE/FAILED
  string message = 4;
  google.protobuf.Struct meta = 5;
  ErrorInfo error = 6;

  map<string, VariantResult> results_by_variant_id = 10;
}

// ------------------------------------------------------------
// Watch (optional server stream)
// ------------------------------------------------------------

message WatchJobRequest {
  string job_id = 1;
  bool send_initial = 2;
}

message JobEvent {
  enum Type {
    TYPE_UNSPECIFIED = 0;
    STATUS = 1;
    PARTIAL = 2;
    DONE = 3;
    FAILED = 4;
    HEARTBEAT = 10;
  }
  Type type = 1;

  Status status = 2;
  PartialConvertResult partial = 3;
}

// ------------------------------------------------------------
// Services
// ------------------------------------------------------------

service Converter {
  rpc SubmitConvert (SubmitConvertRequest) returns (JobAck);
  rpc GetStatus (GetStatusRequest) returns (Status);
  rpc GetPartialResult (GetPartialResultRequest) returns (PartialConvertResult);
  rpc GetResult (GetResultRequest) returns (ConvertResult);
  rpc WatchJob (WatchJobRequest) returns (stream JobEvent);
}